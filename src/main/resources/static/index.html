<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>查询/下载证书</title>
    <style type="text/css">
        body {
            background-color: #999;
        }
    </style>
    <link rel="stylesheet" href="bootstrap-4.3.1/css/bootstrap.min.css">
    <script src="jquery/jquery-3.4.1.min.js"></script>
    <script src="bootstrap-4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
<div class="jumbotron text-center">
    <h3>证书查询/下载服务相关</h3>
    <!--<p>Resize this responsive page to see the effect!</p>-->
</div>
<div class="container">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#certificateDownloadByPhone">证书下载</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#certificateQueryBySerialNum">证书查询</a>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div id="certificateDownloadByPhone" class="container tab-pane active"><br>
            <h4>请输入手机号及手机验证码</h4>
            <label for="phone" class="sr-only">phone number</label>
            <input type="tel" id="phone" class="form-control" placeholder="手机号" onkeyup="checkPhone()"
                   onblur="checkPhone()" autofocus>
            <br/>

            <div class="input-group">
                <label for="code" class="sr-only">verification code</label>
                <input type="text" id="code" class="form-control" onkeyup="checkCode()" onblur="checkCode()"
                       placeholder="验证码（有效期60秒）">
                <button type="submit" class="btn btn-primary input-group-addon" onclick="getCode(this)" disabled
                        id="J_getCode">获取验证码
                </button>
                <button type="reset" class="btn btn-small input-group-addon" id="J_resetCode" style="display:none;">
                    <span id="J_second">60</span>秒后重发
                </button>
            </div>

            <br/>
            <br/>
            <button class="btn btn-lg btn-primary btn-block" onclick="getDownloadURL()" type="submit" disabled
                    id="commitBtn">获取证书
            </button>
        </div>
        <div id="certificateQueryBySerialNum" class="container tab-pane fade"><br>
            <h4>请输入证书编号</h4>
            <div class="input-group">
                <input type="text" id="serialNum" class="form-control"
                       placeholder="证书编号"/>
                <button type="button" class="btn btn-primary input-group-addon" onclick="queryCertificateInfo()">查询</button>
            </div>
            <div style="margin-top:50px" >
                <ul class="list-group list-group-flush" id="certificateInfo" style="display: none">
                    <li class="list-group-item  justify-content-between align-items-center">
                        姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：
                        <span name="certificateInfo.userName">姓名</span>
                    </li>
                    <li class="list-group-item  justify-content-between align-items-center">
                        证书编号：
                        <span name="certificateInfo.serialNum">证书编号</span>
                    </li>
                    <li class="list-group-item  justify-content-between align-items-center">
                        证书名称：
                        <span name="certificateInfo.certificateName">证书名称</span>
                    </li>
                    <li class="list-group-item  justify-content-between align-items-center">
                        发证时间：
                        <span name="certificateInfo.issueTime">发证时间</span>
                    </li>
                    <li class="list-group-item  justify-content-between align-items-center">
                        发证单位：
                        <span name="certificateInfo.issuingUnit">发证单位</span>
                    </li>
                </ul>
                <div class="text-center" id="noCertificateInfo" style="display: none">
                    <p>没有找到该证书相关信息！</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /*获取验证码*/
    var isPhone = 1;
    var existPhone = 0;
    function getCode(e) {
        if (isPhone) {
            // 发请求至后台
            $.ajax({
                url: "/certificate/getVerificationCode",
                data: {"phone": $('#phone').val()},
                dataType: "json",
                method: "POST"
            }).done(function (msg) {
                console.log(msg);
                if (msg.code == 0) {
                    existPhone = 1;
                    resetCode(); //倒计时
                } else {
                    existPhone = 0;
                    alert(msg.message);
                }
            });

        } else {
            $('#phone').focus();
        }
    }
    //验证手机号码
    function checkPhone() {
        var phone = $('#phone').val();
        isPhone = 1;
        if (phone == '' || !(/^1[3456789]\d{9}$/.test(phone))) {
            isPhone = 0;
            $("#J_getCode").attr("disabled", "true");
        } else {
            $("#J_getCode").removeAttr("disabled");
        }
    }

    //验证手机号码
    function checkCode() {
        var phone = $('#phone').val();
        if (phone == '' || !(/^1[3456789]\d{9}$/.test(phone))) {
            $("#commitBtn").attr("disabled", "true");
        } else {
            if ((/^\d{4,}$/.test($("#code").val())) && existPhone) {
                $("#commitBtn").removeAttr("disabled");
            } else {
                $("#commitBtn").attr("disabled", "true");
            }
        }
    }
    //倒计时
    function resetCode() {
        var second = 60;
        $('#J_getCode').hide();
        $('#J_second').html(second);
        $('#J_resetCode').show();

        var timer = null;
        timer = setInterval(function () {
            second -= 1;
            if (second > 0) {
                $('#J_second').html(second);
            } else {
                clearInterval(timer);
                $('#J_getCode').show();
                $('#J_resetCode').hide();
            }
        }, 1000);
    }
    // 下载证书图片
    function getDownloadURL() {
        // 发请求至后台
        $.ajax({
            url: "/certificate/getDownloadURL",
            data: {phone: $('#phone').val(), verificationCode: $('#code').val()},
            dataType: "json",
            method: "POST"
        }).done(function (msg) {
            if (msg.code == 0) {
                window.location.href = "/certificate/download/" + msg.data;
            } else {
                alert(msg.message);
            }
        });
    }
    // 查询证书信息
    function queryCertificateInfo() {
        // 发请求至后台
        $.ajax({
            url: "/certificate/queryCertificateInfo",
            data: {serialNum: $('#serialNum').val()},
            dataType: "json",
            method: "POST"
        }).done(function (msg) {
            if (msg.code == 0) {
                var certificateInfo = msg.data;
                if(certificateInfo == null){
                    $("#noCertificateInfo").show();
                    $("#certificateInfo").hide();
                }else {
                    $("span[name='certificateInfo.userName']").text(certificateInfo.userName);
                    $("span[name='certificateInfo.serialNum']").text(certificateInfo.serialNum);
                    $("span[name='certificateInfo.certificateName']").text(certificateInfo.certificateName);
                    $("span[name='certificateInfo.issueTime']").text(certificateInfo.issueTime);
                    $("span[name='certificateInfo.issuingUnit']").text(certificateInfo.issuingUnit);
                    $("#certificateInfo").show();
                    $("#noCertificateInfo").hide();
                }
            } else {
                alert(msg.message);
            }
        });
    }
</script>
</body>
</html>