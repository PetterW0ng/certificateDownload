<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>下载我的证书</title>
    <style type="text/css">
        body {
            background-color: #999;
        }
    </style>
    <link rel="stylesheet" href="bootstrap-4.3.1/css/bootstrap.min.css">
    <script src="jquery/jquery-3.4.1.min.js"></script>
    <script src="bootstrap-4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container">
    <div class ="m-auto">
        <div class="form-signin"  style="margin-top: 200px">
            <h2 class="form-signin-heading" style="font-size: medium">请输入手机号及手机验证码</h2>
            <label for="phone" class="sr-only">phone number</label>
            <input type="tel" id="phone" class="form-control" placeholder="手机号" onkeyup="checkPhone()"
                   onblur="checkPhone()" autofocus>
            <br/>

            <div class="input-group">
                <label for="code" class="sr-only">verification code</label>
                <input type="text" id="code" class="form-control" onkeyup="checkCode()" onblur="checkCode()"
                       placeholder="验证码（有效期60秒）">
                <button type="submit" class="btn btn-primary input-group-addon" onclick="getCode(this)" disabled
                        id="J_getCode">获取验证码
                </button>
                <button type="reset" class="btn btn-small input-group-addon" id="J_resetCode" style="display:none;">
                    <span id="J_second">60</span>秒后重发
                </button>
            </div>

            <br/>
            <button class="btn btn-lg btn-primary btn-block" onclick="getDownloadURL()" type="submit" disabled
                    id="commitBtn">获取证书
            </button>
        </div>

    </div> <!-- /container -->

</div>

<script>
    /*获取验证码*/
    var isPhone = 1;
    var existPhone = 0;
    function getCode(e) {
        if (isPhone) {
            // 发请求至后台
            $.ajax({
                url: "/certificate/getVerificationCode",
                data: {"phone": $('#phone').val()},
                dataType: "json",
                method: "POST"
            }).done(function (msg) {
                console.log(msg);
                if (msg.code == 0) {
                    existPhone = 1;
                    resetCode(); //倒计时
                } else {
                    existPhone = 0;
                    alert(msg.message);
                }
            });

        } else {
            $('#phone').focus();
        }
    }
    //验证手机号码
    function checkPhone() {
        var phone = $('#phone').val();
        isPhone = 1;
        if (phone == '' || !(/^1[3456789]\d{9}$/.test(phone))) {
            isPhone = 0;
            $("#J_getCode").attr("disabled", "true");
        } else {
            $("#J_getCode").removeAttr("disabled");
        }
    }

    //验证手机号码
    function checkCode() {
        var phone = $('#phone').val();
        if (phone == '' || !(/^1[3456789]\d{9}$/.test(phone))) {
            $("#commitBtn").attr("disabled", "true");
        } else {
            if ((/^\d{4,}$/.test($("#code").val())) && existPhone) {
                $("#commitBtn").removeAttr("disabled");
            } else {
                $("#commitBtn").attr("disabled", "true");
            }
        }
    }
    //倒计时
    function resetCode() {
        var second = 60;
        $('#J_getCode').hide();
        $('#J_second').html(second);
        $('#J_resetCode').show();

        var timer = null;
        timer = setInterval(function () {
            second -= 1;
            if (second > 0) {
                $('#J_second').html(second);
            } else {
                clearInterval(timer);
                $('#J_getCode').show();
                $('#J_resetCode').hide();
            }
        }, 1000);
    }
    // 下载页面
    function getDownloadURL() {
        // 发请求至后台
        $.ajax({
            url: "/certificate/getDownloadURL",
            data: {phone: $('#phone').val(), verificationCode: $('#code').val()},
            dataType: "json",
            method: "POST"
        }).done(function (msg) {
            console.log(msg);
            if (msg.code == 0) {
                window.location.href = "/certificate/download/" + msg.data;
            } else {
                alert(msg.message);
            }
        });
    }
</script>
</body>
</html>